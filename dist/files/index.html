<!DOCTYPE html>
<html class="flex" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload File</title>
    <link href="index.css" rel="stylesheet" type="text/css">
</head>
<script>
    const fetchWithProgress = (url, {method = 'GET', body} = {}, onProgress = null, onLoadStart = null) => new Promise((res, rej) => {
        const xhr = new XMLHttpRequest();
        xhr.open(method, url);
        xhr.onload = res;
        xhr.onerror = rej;
        if (xhr.upload && onProgress) {
            xhr.upload.onprogress = onProgress;
            xhr.upload.onloadstart = onLoadStart;
        }
        xhr.send(body);
    });

    function onProgress({loaded, total}) {
        const percentage = Math.round((loaded * 100) / total);
        const formattedTotal = formatBytes(total);
        const formattedLoaded = formatBytes(loaded);
        document.querySelector('.progress progress').setAttribute('value', `${percentage}`);
        document.querySelector('.progress .uploading-file-size').textContent = `${formattedLoaded} of ${formattedTotal}`;
        if (percentage !== 100) {
            document.querySelector('.progress .uploading-percentage').textContent = `Uploading... ${percentage}%`;
            return;
        }
        document.querySelector('.progress .uploading-percentage').textContent = `Uploaded... ${percentage}%`;
    }

    function uploadFile(body) {
        fetchWithProgress(`/files/${body.name}`, {method: 'Post', body}, onProgress, onLoadStart(body));
    }

    function onLoadStart(file) {
        return function() {
            document.querySelector('.progress .name').textContent = file.name;
            document.querySelector('.progress').style = 'display: flex';
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const bytesInKb = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const exponent = Math.floor(Math.log(bytes) / Math.log(bytesInKb));
        return `${parseFloat((bytes / Math.pow(bytesInKb, exponent)).toFixed(0))} ${sizes[exponent]}`;
    }
</script>
<body class="flex">
<div class="file-upload flex column justify-content-space-around">
   <span class="title">
            File upload
        </span>
    <div class="drop-zone flex column justify-content-space-between align-items-center">
        <img class="file-image" src="../images/icons8-add-file-48.png"/>
        <div>
            Drag and drop or <a href="#">browse</a> your files
        </div>
        <input onchange="uploadFile(this.files[0])" type="file"/>
    </div>
    <div class="progress flex">
        <img src="../images/icons8-jpg-50.png"/>
        <div class="flex column flex1 justify-content-stretch">
            <span class="name"></span>
            <progress class="progress-bar" max="100" value="0">0 %</progress>
            <div class="flex justify-content-space-between">
                <span class="uploading-file-size"></span>
                <span class="uploading-percentage"></span>
            </div>
        </div>
    </div>
    <button class="done">DONE</button>
</div>
</body>
<script>
    document.querySelector('.file-upload .drop-zone').addEventListener('click', function ({target}) {
        const $fileInput = document.querySelector('.file-upload .drop-zone input[type=file]');
        if ($fileInput === target) {
            return;
        }
        $fileInput.click();
    });
</script>
</html>
